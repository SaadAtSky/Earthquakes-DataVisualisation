<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bubble Map Demo</title>

    <!-- Include Plotly JavaScript library -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <!-- Include Axios - used by boundary_info.js  -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <!-- Include my JavaScript files -->
    <script src="location_data.js"></script>
    <script src="sentiment_data.js"></script>
</head>
<body>

<!-- Create DIV to hold the map -->
<div id="mapDiv" style="width:1000px;height:1000px;"></div>

<script>
    //Key for Mapbox API
    const MAPBOX_TOKEN='pk.eyJ1IjoiZGFvZ2FtZXoiLCJhIjoiY2pzdDZuazJ3MXVjbjQ5bzQ3YTFkbTg3OSJ9.l-KpHe-EPYvi3qfxQJSCUg';

    //Number of random points we want to plot
    const numLocations = 50;

    //Data structure holding the points and labels.
    let locations;

    //Loads geometry data if it has not been loaded, then plots sentiment
    function drawMap(){
        //Only pull location data once to improve performance
        if(locations === undefined){
            //Gets random points within London
            locations = getLondonLocations(numLocations);

            //Plot sentiment data on map
            plotSentiment();
        }
        //We have already loaded the location data - just plot sentiment
        else{
            plotSentiment();
        }
    }

    //Plots the sentiment of random locations within London
    function plotSentiment() {
        //Randomly generates a sentiment result for each location
        let demoSentimentData = getDemoSentimentData(numLocations);

        //Convert sentiment data into bubble sizes
        let sentimentArray = demoSentimentData.map( sentiment => {
            return sentiment.SentimentScore.Positive * 100;
        });

        //Build layout for plot
        let layout = {
            title: "Sentiment at London Locations",
            height: 1000,
            width: 1000,
            mapbox: {
                center: {
                    lat: 51.515847,
                    lon: -0.108752
                },
                style: 'dark',
                zoom: 9,
            }
        };

        //Put random locations and sentiment into data
        let data = [{
            type: 'scattermapbox',
            lat: locations.latArray,
            lon: locations.lonArray,
            hoverinfo: 'text',
            text: locations.labelArray,
            marker: {
                size: sentimentArray,
                color: "red",
                line: {
                    color: 'black',
                    width: 2
                },
            }
        }];

        //Need mapbox token to use Mapbox maps.
        let config = {
            mapboxAccessToken: MAPBOX_TOKEN
        };

        //Plot data on map
        Plotly.newPlot("mapDiv", data, layout, config);
    }

    //Plot data on map
    window.onload = drawMap;

    //Redraw sentiment every 5 seconds
    //setInterval(drawMap, 5000);

</script>

</body>
</html>